---
aliases:
tags:
  - rust
data: 2025-10-04T14:25:00
---

```rust
let list = Cons(1, Box::new(Cons(2, Box::new(Cons(3, Box::new(Nil))))));
```

下面就是内存布局图：

```
       STACK (栈)                                  HEAP (堆)
   +----------------------+
   | list                 |
   | -------------------- |                 +--------------------------------+
   | Cons(                |                 | Address: 0xAAAA                |
   |   value: 1,          |                 | ------------------------------ |
   |   next: (Box) ptr ---+---------------> | Cons(                          |
   | )                    |                 |   value: 2,                    |
   +----------------------+                 |   next: (Box) ptr ---+         |
                                            | )                      |         |
                                            +------------------------+         |
                                                                     |         |
                                            +------------------------+ <-------+
                                            | Address: 0xBBBB        |
                                            | ---------------------- |
                                            | Cons(                  |
                                            |   value: 3,            |
                                            |   next: (Box) ptr ---+ |
                                            | )                      | |
                                            +------------------------+ |
                                                                       |
                                            +------------------------+ <-------+
                                            | Address: 0xCCCC        |
                                            | ---------------------- |
                                            | Nil                    |
                                            +------------------------+

```

---

### 图解说明：

1. **从栈 (STACK) 开始：**
    
    - 我们的程序里有一个变量叫 `list`，它被存放在**栈**上。
        
    - 这个 `list` 变量本身就是我们链表的第一个节点 `Cons`。它包含两部分：
        
        - 值 `value: 1`。
            
        - 一个智能指针 `Box`。这个 `Box` 的内容其实就是一个指向**堆**的内存地址 (`ptr`)。
            
2. **第一个“桥梁” `Box`：**
    
    - 栈上的第一个 `Box` 指针，指向了堆上地址为 `0xAAAA` 的一块内存。
        
    - 这块内存里存放着我们链表的**第二个节点**：`Cons(value: 2, next: (Box) ptr)`。
        
    - 你看，第二个节点的数据（值 `2` 和指向下一个节点的指针）完整地存放在**堆**上。
        
3. **第二个和第三个 `Box`：**
    
    - 堆上的第二个节点里，同样包含一个 `Box` 指针，它又指向了堆上的另一块内存 `0xBBBB`。
        
    - `0xBBBB` 里存放着我们的**第三个节点**：`Cons(value: 3, ...)`。
        
    - 第三个节点里的 `Box` 指针，最终指向了堆上的 `0xCCCC`，这里存放的是链表的终点 `Nil`。
        

**核心思想总结：**

- 整个链表的数据，除了第一个节点的值 `1` 和第一个指针之外，其余所有部分都零散地存放在**堆**上。
    
- `Box` 就像一条条“锁链”，将这些分散在堆上的节点一个一个地链接起来，形成了一个完整的逻辑链表。
    
- 而在**栈**上，我们只需要一个 `list` 变量，它的大小是固定的（`i32` 的大小 + 一个指针的大小），编译器因此非常满意。
    
